<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ texts.title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="wrap">
        <header class="header">
            <h1>{{ texts.title }}</h1>
        </header>

        <form id="search-form" class="form" method="post" action="{{ url_for('index') }}">
            <div class="form-row">
                <label for="lang-select">{{ texts.lang_label }}</label>
                <select id="lang-select" name="lang" onchange="switchLang(this.value)">
                    <option value="ru" {{ 'selected' if lang == 'ru' }}>RU</option>
                    <option value="en" {{ 'selected' if lang == 'en' }}>EN</option>
                </select>
            </div>
            <div class="form-row">
                <label for="city">{{ texts.city_label }}</label>
                <input type="text" id="city" name="city" value="{{ city or '' }}" placeholder="Москва" required>
            </div>
            <div class="form-row">
                <label for="query">{{ texts.query_label }}</label>
                <input type="text" id="query" name="query" value="{{ query or '' }}" placeholder="Python" required>
            </div>
            <div class="form-row form-row-check">
                <label class="checkbox-label">
                    <input type="checkbox" name="fast" value="1" id="fast">
                    <span>{{ texts.fast_search }}</span>
                </label>
            </div>
            <button type="submit" class="btn btn-primary" id="submit-btn">{{ texts.search_btn }}</button>
        </form>

        <div id="progress-block" class="progress-block" style="display: none;">
            <div class="progress-bar-wrap">
                <div id="progress-bar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <p id="progress-msg" class="progress-msg"></p>
        </div>

        <div id="error-block" class="message message-error" style="display: none;"></div>
        {% if error %}
        <div class="message message-error" id="server-error">{{ error }}</div>
        {% endif %}

        <div id="results-area" style="display: {{ 'block' if count is defined else 'none' }};">
            <div class="results-header">
                <span id="results-count" class="results-count">{% if count is defined %}{{ found_msg or '' }}{% endif %}</span>
                {% if count is defined and count > 0 and cache_key %}
                <a id="export-link" href="{{ url_for('export', key=cache_key) }}" class="btn btn-outline">{{ texts.export_btn }}</a>
                {% else %}
                <a id="export-link" href="#" class="btn btn-outline" style="display: none;">{{ texts.export_btn }}</a>
                {% endif %}
            </div>

            <div class="tabs">
                <button type="button" class="tab-btn active" data-tab="results">{{ texts.tab_results }}</button>
                <button type="button" class="tab-btn" data-tab="analytics">{{ texts.tab_analytics }}</button>
            </div>

            <div id="tab-results" class="tab-pane active">
                <div class="table-wrap">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>{{ texts.vacancy }}</th>
                                <th>{{ texts.company }}</th>
                                <th>{{ texts.city }}</th>
                                <th>{{ texts.salary }}</th>
                                <th>{{ texts.link }}</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                    {% if vacancies %}
                    {% for v in vacancies %}
                    <tr>
                        <td class="cell-name">{{ (v.name or '')[:80] }}</td>
                        <td>{{ (v.company or '—')[:40] }}</td>
                        <td>{{ v.city or '—' }}</td>
                        <td>{{ v.salary_str or '—' }}</td>
                        <td class="cell-link">{% if v.url %}<a href="{{ v.url }}" target="_blank" rel="noopener">HH.ru</a>{% else %}—{% endif %}</td>
                        <td><button type="button" class="btn btn-sm btn-detail" data-index="{{ loop.index0 }}">{{ texts.details }}</button></td>
                    </tr>
                    {% endfor %}
                    {% endif %}
                </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-analytics" class="tab-pane">
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <h3 id="label-direction">{{ texts.by_direction }}</h3>
                        <canvas id="chart-direction" height="220"></canvas>
                    </div>
                    <div class="analytics-card">
                        <h3 id="label-technology">{{ texts.by_technology }}</h3>
                        <canvas id="chart-technology" height="220"></canvas>
                    </div>
                    <div class="analytics-card full">
                        <h3 id="label-companies">{{ texts.top_companies }}</h3>
                        <div id="companies-bars" class="companies-bars"></div>
                    </div>
                    <div class="analytics-card">
                        <h3 id="label-salary">{{ texts.salary_dist }}</h3>
                        <canvas id="chart-salary" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal" aria-hidden="true">
        <div class="modal-backdrop" onclick="closeModal()"></div>
        <div class="modal-box">
            <button type="button" class="modal-close" onclick="closeModal()" aria-label="Close">&times;</button>
            <h2 id="modal-title" class="modal-title"></h2>
            <dl class="modal-meta">
                <dt>{{ texts.company }}</dt><dd id="modal-company"></dd>
                <dt>{{ texts.city }}</dt><dd id="modal-city"></dd>
                <dt>{{ texts.salary }}</dt><dd id="modal-salary"></dd>
                <dt>{{ texts.link }}</dt><dd id="modal-link"></dd>
            </dl>
            <h3 class="modal-desc-title">{{ texts.description }}</h3>
            <div id="modal-description" class="modal-description"></div>
        </div>
    </div>

    <script>
        window.vacanciesData = {% if vacancies %}{{ vacancies_json | safe }}{% else %}[]{% endif %};
        var exportBase = "{{ url_for('export') }}";

        function switchLang(lang) {
            window.location.href = "{{ url_for('index') }}?lang=" + lang;
        }

        function formatSalary(v) {
            if (!v) return "—";
            var a = v.salary_from, b = v.salary_to, c = v.currency || "";
            if (a && b) return a + " – " + b + " " + c;
            if (a) return "от " + a + " " + c;
            if (b) return "до " + b + " " + c;
            return "—";
        }

        function escapeHtml(s) {
            if (!s) return "";
            var div = document.createElement("div");
            div.textContent = s;
            return div.innerHTML;
        }

        function openDetail(v) {
            document.getElementById("modal-title").textContent = v.name || "—";
            document.getElementById("modal-company").textContent = v.company || "—";
            document.getElementById("modal-city").textContent = v.city || "—";
            document.getElementById("modal-salary").textContent = formatSalary(v);
            var linkEl = document.getElementById("modal-link");
            if (v.url) {
                linkEl.innerHTML = '<a href="' + escapeHtml(v.url) + '" target="_blank" rel="noopener">' + escapeHtml(v.url) + '</a>';
            } else {
                linkEl.textContent = "—";
            }
            var desc = v.description || "—";
            document.getElementById("modal-description").innerHTML = escapeHtml(desc).replace(/\n/g, "<br>");
            document.getElementById("modal").setAttribute("aria-hidden", "false");
            document.body.classList.add("modal-open");
        }

        function closeModal() {
            document.getElementById("modal").setAttribute("aria-hidden", "true");
            document.body.classList.remove("modal-open");
        }

        document.getElementById("modal").addEventListener("keydown", function(e) {
            if (e.key === "Escape") closeModal();
        });

        document.body.addEventListener("click", function(e) {
            var btn = e.target.closest(".btn-detail");
            if (!btn) return;
            e.preventDefault();
            var idx = parseInt(btn.getAttribute("data-index"), 10);
            if (isNaN(idx) || !window.vacanciesData || !window.vacanciesData[idx]) return;
            openDetail(window.vacanciesData[idx]);
        });

        // Tabs
        document.querySelectorAll(".tab-btn").forEach(function(btn) {
            btn.addEventListener("click", function() {
                var tab = this.getAttribute("data-tab");
                document.querySelectorAll(".tab-btn").forEach(function(b) { b.classList.remove("active"); });
                document.querySelectorAll(".tab-pane").forEach(function(p) { p.classList.remove("active"); });
                this.classList.add("active");
                document.getElementById("tab-" + tab).classList.add("active");
            });
        });

        var chartDirection = null, chartTechnology = null, chartSalary = null;

        function destroyCharts() {
            if (chartDirection) { chartDirection.destroy(); chartDirection = null; }
            if (chartTechnology) { chartTechnology.destroy(); chartTechnology = null; }
            if (chartSalary) { chartSalary.destroy(); chartSalary = null; }
        }

        function renderAnalytics(analytics, texts) {
            destroyCharts();
            var colors = ["#7aa2f7", "#9ece6a", "#e0af68", "#bb9af7", "#f7768e", "#73daca", "#c0caf5", "#a9b1d6"];

            if (analytics.by_direction && Object.keys(analytics.by_direction).length > 0) {
                chartDirection = new Chart(document.getElementById("chart-direction"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(analytics.by_direction),
                        datasets: [{ label: texts.by_direction || "", data: Object.values(analytics.by_direction), backgroundColor: colors }]
                    },
                    options: {
                        indexAxis: "y",
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { ticks: { color: "#a9b1d6" }, grid: { color: "#414868" } }, y: { ticks: { color: "#a9b1d6" }, grid: { display: false } } }
                    }
                });
            }

            if (analytics.by_technology && Object.keys(analytics.by_technology).length > 0) {
                var techLabels = Object.keys(analytics.by_technology);
                var techData = Object.values(analytics.by_technology);
                chartTechnology = new Chart(document.getElementById("chart-technology"), {
                    type: "doughnut",
                    data: {
                        labels: techLabels,
                        datasets: [{ data: techData, backgroundColor: colors.concat(["#414868", "#565f89"]) }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: "right", labels: { color: "#c0caf5", padding: 12 } } }
                    }
                });
            }

            var companiesEl = document.getElementById("companies-bars");
            companiesEl.innerHTML = "";
            if (analytics.top_companies && analytics.top_companies.length > 0) {
                var maxCount = Math.max.apply(null, analytics.top_companies.map(function(x) { return x[1]; }));
                analytics.top_companies.forEach(function(item) {
                    var pct = maxCount > 0 ? (100 * item[1] / maxCount) : 0;
                    var div = document.createElement("div");
                    div.className = "company-row";
                    div.innerHTML = "<span class=\"company-name\">" + escapeHtml(item[0]) + "</span><span class=\"company-count\">" + item[1] + "</span><div class=\"company-bar-wrap\"><div class=\"company-bar\" style=\"width:" + pct + "%\"></div></div>";
                    companiesEl.appendChild(div);
                });
            }

            if (analytics.salary_dist && Object.keys(analytics.salary_dist).length > 0) {
                chartSalary = new Chart(document.getElementById("chart-salary"), {
                    type: "bar",
                    data: {
                        labels: Object.keys(analytics.salary_dist),
                        datasets: [{ label: texts.salary_dist || "", data: Object.values(analytics.salary_dist), backgroundColor: "#7aa2f7" }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { x: { ticks: { color: "#a9b1d6" }, grid: { color: "#414868" } }, y: { ticks: { color: "#a9b1d6" }, grid: { color: "#414868" } }
                    }
                });
            }
        }

        document.getElementById("search-form").addEventListener("submit", function(e) {
            e.preventDefault();
            var city = document.getElementById("city").value.trim();
            var query = document.getElementById("query").value.trim();
            var lang = document.getElementById("lang-select").value;
            var fast = document.getElementById("fast").checked;

            document.getElementById("error-block").style.display = "none";
            var se = document.getElementById("server-error");
            if (se) se.style.display = "none";
            document.getElementById("results-area").style.display = "none";
            document.getElementById("progress-block").style.display = "block";
            document.getElementById("progress-bar").style.width = "0%";
            document.getElementById("progress-msg").textContent = "{{ texts.loading }}";
            document.getElementById("submit-btn").disabled = true;

            fetch("{{ url_for('search_start') }}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Accept": "application/json" },
                body: JSON.stringify({ city: city, query: query, lang: lang, fast: fast })
            })
            .then(function(r) {
                return r.json().then(function(data) {
                    if (!r.ok) throw new Error(data.error || "Ошибка сервера " + r.status);
                    return data;
                });
            })
            .then(function(data) {
                if (data.error) throw new Error(data.error);
                return data.search_id;
            })
            .then(function(searchId) {
                return new Promise(function(resolve, reject) {
                    function poll2() {
                        fetch("/search_status/" + searchId)
                        .then(function(r) { return r.json(); })
                        .then(function(st) {
                            document.getElementById("progress-bar").style.width = (st.progress || 0) + "%";
                            document.getElementById("progress-msg").textContent = st.message || "";
                            if (st.status === "done") { resolve(searchId); return; }
                            if (st.status === "error") { reject(new Error(st.message || "Ошибка")); return; }
                            setTimeout(poll2, 400);
                        })
                        .catch(reject);
                    }
                    poll2();
                });
            })
            .then(function(searchId) {
                return fetch("/search_result/" + searchId).then(function(r) { return r.json(); });
            })
            .then(function(data) {
                document.getElementById("progress-block").style.display = "none";
                document.getElementById("submit-btn").disabled = false;

                window.vacanciesData = data.vacancies || [];
                document.getElementById("results-count").textContent = data.found_msg || "";
                var exportLink = document.getElementById("export-link");
                if (data.cache_key) {
                    exportLink.href = exportBase + "?key=" + encodeURIComponent(data.cache_key);
                    exportLink.style.display = "inline-block";
                }

                var tbody = document.getElementById("table-body");
                tbody.innerHTML = "";
                var texts = data.texts || {};
                (data.vacancies || []).forEach(function(v, i) {
                    var tr = document.createElement("tr");
                    var salaryStr = v.salary_str || formatSalary(v);
                    var urlCell = v.url ? '<a href="' + escapeHtml(v.url) + '" target="_blank" rel="noopener">HH.ru</a>' : "—";
                    tr.innerHTML = "<td class=\"cell-name\">" + escapeHtml((v.name || "").slice(0, 80)) + "</td><td>" + escapeHtml((v.company || "—").slice(0, 40)) + "</td><td>" + escapeHtml(v.city || "—") + "</td><td>" + escapeHtml(salaryStr) + "</td><td class=\"cell-link\">" + urlCell + "</td><td><button type=\"button\" class=\"btn btn-sm btn-detail\" data-index=\"" + i + "\">" + (texts.details || "Подробнее") + "</button></td>";
                    tbody.appendChild(tr);
                });

                document.getElementById("results-area").style.display = "block";
                try {
                    if (data.analytics && typeof Chart !== "undefined") renderAnalytics(data.analytics, texts);
                } catch (err) { console.warn("Charts:", err); }
            })
            .catch(function(err) {
                document.getElementById("progress-block").style.display = "none";
                document.getElementById("submit-btn").disabled = false;
                document.getElementById("error-block").textContent = err.message || "Ошибка";
                document.getElementById("error-block").style.display = "block";
            });
        });

        {% if analytics %}
        (function() {
            try {
                var analytics = {{ analytics | tojson }};
                var texts = {"by_direction": "{{ texts.by_direction }}", "by_technology": "{{ texts.by_technology }}", "top_companies": "{{ texts.top_companies }}", "salary_dist": "{{ texts.salary_dist }}"};
                if (typeof renderAnalytics === "function" && typeof Chart !== "undefined") renderAnalytics(analytics, texts);
            } catch (e) { console.warn(e); }
        })();
        {% endif %}
    </script>
</body>
</html>
