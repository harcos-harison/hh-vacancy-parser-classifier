import streamlit as st
import pandas as pd
import plotly.express as px

# --- –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–†–ê–ù–ò–¶–´ ---
st.set_page_config(page_title="–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤–∞–∫–∞–Ω—Å–∏–π 2026", layout="wide")

# --- –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• ---
# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –∏–º–∏—Ç–∏—Ä—É—è —Ç–≤–æ–π Excel (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∏ —Å–≤–æ–π df)
@st.cache_data
def load_data():
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ:
    # df = pd.read_excel("classified_vacancies.xlsx")
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
    raw_data = {
        'category': ['Backend']*13 + ['Data']*10 + ['QA']*4 + ['DevOps']*1,
        'experience': [
            '3-6 –ª–µ—Ç', '3-6 –ª–µ—Ç', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '–ù–µ—Ç –æ–ø—ã—Ç–∞', '–ù–µ—Ç –æ–ø—ã—Ç–∞', '6+ –ª–µ—Ç', '6+ –ª–µ—Ç', # Backend
            '3-6 –ª–µ—Ç', '3-6 –ª–µ—Ç', '3-6 –ª–µ—Ç', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', '–ù–µ—Ç –æ–ø—ã—Ç–∞', '–ù–µ—Ç –æ–ø—ã—Ç–∞', '–ù–µ—Ç –æ–ø—ã—Ç–∞', # Data
            '–ù–µ—Ç –æ–ø—ã—Ç–∞', '–ù–µ—Ç –æ–ø—ã—Ç–∞', '1-3 –≥–æ–¥–∞', '1-3 –≥–æ–¥–∞', # QA
            '3-6 –ª–µ—Ç' # DevOps
        ]
    }
    return pd.DataFrame(raw_data)

df = load_data()

# --- –õ–û–ì–ò–ö–ê –ê–ù–ê–õ–ò–ó–ê –û–ü–´–¢–ê ---
# –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏ —Å—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –û—à–∏–±–∫–∞ "All arrays must be of the same length" —Ç–µ–ø–µ—Ä—å –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.
exp_stats = df.groupby(['category', 'experience']).size().reset_index(name='count')

# –°–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
order = df['category'].value_counts().index.tolist()

# --- –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø ---
st.title("üìä –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥–∞ –≤ IT")
st.markdown("""
–≠—Ç–æ—Ç –≥—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç **–ø—Ä–æ–ø–æ—Ä—Ü–∏—é –æ–ø—ã—Ç–∞**. –ß–µ–º –±–æ–ª—å—à–µ **—Ç–µ–º–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞**, —Ç–µ–º –≤—ã—à–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞–º 
–∏ —Ç–µ–º —Å–ª–æ–∂–Ω–µ–µ ¬´–≤–æ–π—Ç–∏¬ª –≤ —ç—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ.
""")

# –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫
# 1. –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫ –±–µ–∑ barnorm –≤–Ω—É—Ç—Ä–∏
fig = px.bar(
    exp_stats, 
    y="category", 
    x="count", 
    color="experience", 
    orientation='h',
    category_orders={"category": order, "experience": ["–ù–µ—Ç –æ–ø—ã—Ç–∞", "1-3 –≥–æ–¥–∞", "3-6 –ª–µ—Ç", "6+ –ª–µ—Ç"]},
    text_auto='.1f', 
    title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ–º–æ–≥–æ –æ–ø—ã—Ç–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º (%)",
    color_discrete_map={
        '–ù–µ—Ç –æ–ø—ã—Ç–∞': '#B2FFB2', 
        '1-3 –≥–æ–¥–∞': '#4CAF50',  
        '3-6 –ª–µ—Ç': '#2E7D32',   
        '6+ –ª–µ—Ç': '#1B5E20'     
    }
)

# 2. –ê —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º "100% —Å—Ç–µ–∫–∏–Ω–≥" —á–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Layout
fig.update_layout(
    barmode='stack', 
    barnorm='percent', # <--- –ü–µ—Ä–µ–Ω–µ—Å–ª–∏ —Å—é–¥–∞
    xaxis_title="–ü—Ä–æ—Ü–µ–Ω—Ç –≤–∞–∫–∞–Ω—Å–∏–π",
    yaxis_title="",
    legend_title="–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã",
    plot_bgcolor='rgba(0,0,0,0)'
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞
fig.update_layout(
    xaxis_title="–ü—Ä–æ—Ü–µ–Ω—Ç –≤–∞–∫–∞–Ω—Å–∏–π",
    yaxis_title="",
    legend_title="–û–ø—ã—Ç —Ä–∞–±–æ—Ç—ã",
    legend_traceorder="normal",
    plot_bgcolor='rgba(0,0,0,0)',
    uniformtext_minsize=8, 
    uniformtext_mode='hide'
)

# –í—ã–≤–æ–¥ –≤ Streamlit
st.plotly_chart(fig, use_container_width=True)

# --- –ò–ù–°–ê–ô–¢–´ ---
st.divider()
col1, col2 = st.columns(2)

# –ê–≤—Ç–æ-—Ä–∞—Å—á–µ—Ç —Å–∞–º–æ–≥–æ –ª–µ–≥–∫–æ–≥–æ –≤—Ö–æ–¥–∞
easy_entry = exp_stats[exp_stats['experience'] == '–ù–µ—Ç –æ–ø—ã—Ç–∞'].sort_values('count', ascending=False)
if not easy_entry.empty:
    with col1:
        st.success(f"‚úÖ **–õ–µ–≥–∫–∏–π –≤—Ö–æ–¥:** –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ **{easy_entry.iloc[0]['category']}** –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —à–∞–Ω—Å–æ–≤ –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤.")

# –ê–≤—Ç–æ-—Ä–∞—Å—á–µ—Ç —Å–∞–º–æ–≥–æ —Å–ª–æ–∂–Ω–æ–≥–æ –≤—Ö–æ–¥–∞
hard_entry = exp_stats[exp_stats['experience'].isin(['3-6 –ª–µ—Ç', '6+ –ª–µ—Ç'])].groupby('category')['count'].sum().sort_values(ascending=False)
if not hard_entry.empty:
    with col2:
        st.error(f"üî• **–í—ã—Å–æ–∫–∏–π –ø–æ—Ä–æ–≥:** –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ **{hard_entry.index[0]}** —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –æ–ø—ã—Ç–Ω—ã—Ö —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤.")
        
    

# =========================
# 4. –ê–Ω–∞–ª–∏–∑ –∑–∞—Ä–ø–ª–∞—Ç (–ø—Ä–∏–º–µ—Ä)
# =========================

# 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# –ó–¥–µ—Å—å –º—ã —Å—á–∏—Ç–∞–µ–º "–ò–Ω–¥–µ–∫—Å –≤—Ö–æ–¥–∞" (–ø—Ä–æ—Ü–µ–Ω—Ç –≤–∞–∫–∞–Ω—Å–∏–π —Å –æ–ø—ã—Ç–æ–º –¥–æ 3 –ª–µ—Ç)
data = {
    '–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ': ['QA', 'Frontend ', 'Data', 'Backend', 'DevOps', 'Management'],
    '–õ–µ–≥–∫–∏–π –≤—Ö–æ–¥ (%)': [75, 60, 45, 30, 15, 5], # –ü—Ä–æ—Ü–µ–Ω—Ç –≤–∞–∫–∞–Ω—Å–∏–π –¥–ª—è –¥–∂—É–Ω–æ–≤
    '–í—Å–µ–≥–æ –≤–∞–∫–∞–Ω—Å–∏–π': [4, 1, 10, 13, 1, 3]
}
df = pd.DataFrame(data).sort_values(by='–õ–µ–≥–∫–∏–π –≤—Ö–æ–¥ (%)', ascending=True)

st.title("üìä –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤—Ö–æ–¥–∞")
st.write("–ö—É–¥–∞ –ø—Ä–æ—â–µ –≤—Å–µ–≥–æ —É—Å—Ç—Ä–æ–∏—Ç—å—Å—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –æ–ø—ã—Ç–æ–º?")

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –∫—Ä–∞—Å–∏–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã
fig = px.bar(
    df, 
    x='–õ–µ–≥–∫–∏–π –≤—Ö–æ–¥ (%)', 
    y='–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',
    orientation='h',
    text='–õ–µ–≥–∫–∏–π –≤—Ö–æ–¥ (%)', # –ü–∏—à–µ–º –ø—Ä–æ—Ü–µ–Ω—Ç—ã –ø—Ä—è–º–æ –Ω–∞ —Å—Ç–æ–ª–±—Ü–∞—Ö
    color='–õ–µ–≥–∫–∏–π –≤—Ö–æ–¥ (%)',
    color_continuous_scale='GnBu', # –ö—Ä–∞—Å–∏–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç –æ—Ç —Å–µ—Ä–æ–≥–æ –∫ –±–∏—Ä—é–∑–æ–≤–æ–º—É
    hover_data=['–í—Å–µ–≥–æ –≤–∞–∫–∞–Ω—Å–∏–π']
)

# 3. –¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è (—É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–π –≤–∏–∑—É–∞–ª—å–Ω—ã–π —à—É–º)
fig.update_traces(
    texttemplate='%{text}%', 
    textposition='outside',
    marker_line_color='rgba(0,0,0,0)', # –£–±–∏—Ä–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç–æ–ª–±—Ü–æ–≤
    width=0.6 # –î–µ–ª–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã —á—É—Ç—å —Ç–æ–Ω—å—à–µ –∏ –∏–∑—è—â–Ω–µ–µ
)

fig.update_layout(
    plot_bgcolor='rgba(0,0,0,0)', # –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω
    paper_bgcolor='rgba(0,0,0,0)',
    xaxis=dict(showgrid=True, gridcolor='lavender', range=[0, 100]),
    yaxis=dict(showgrid=False),
    showlegend=False,
    coloraxis_showscale=False, # –£–±–∏—Ä–∞–µ–º —à–∫–∞–ª—É —Ü–≤–µ—Ç–æ–≤ —Å–±–æ–∫—É
    height=450,
    margin=dict(l=20, r=50, t=50, b=20)
)

# 4. –í—ã–≤–æ–¥ –≤ Streamlit
st.plotly_chart(fig, use_container_width=True)

# 5. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞
st.info("üí° –ß–µ–º –¥–ª–∏–Ω–Ω–µ–µ –ø–æ–ª–æ—Å–∞ –∏ –Ω–∞—Å—ã—â–µ–Ω–Ω–µ–µ —Ü–≤–µ—Ç, —Ç–µ–º –±–æ–ª—å—à–µ –≤–∞–∫–∞–Ω—Å–∏–π –æ—Ç–∫—Ä—ã—Ç–æ –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å –æ–ø—ã—Ç–æ–º 0-3 –≥–æ–¥–∞.")